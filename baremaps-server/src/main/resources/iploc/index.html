<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Baremaps Iploc example</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <style>
        #ip-form{
            margin-bottom: 1rem;
        }
        td, th{
            padding: 1rem;
            border: 1px solid black;
        }
        table {
            border-collapse: collapse;
        }
    </style>
</head>
<body>
<!-- Show my IP address-->
<p>Your IP address is <span id="my-ip"></span></p>
    <!-- A form to submit the IP address -->
    <form id="ip-form" onsubmit="searchByIp(event)">
        <label for="ip">IP address:</label>
        <input type="text" id="ip" name="ip" value=""/>
        <input type="submit" value="Submit"/>
    </form>
<!-- The table of retrieved geo locations addresses -->
<table id="geo-locations"></table>
<script>

    // When the HTML document is loaded, fetch the IP address and display it.
    document.addEventListener('DOMContentLoaded', function () {

    });

    function getIP(json) {
        // Write my IP address to the my-ip span
        document.getElementById('my-ip').textContent = json.ip;
    }

    function searchByIp(event) {
        event.preventDefault();

        // Get the IP address from the form
        var ip = document.getElementById('ip').value;

        // Make a http request on localhost:9100/api/ip/:ip to retrieve the IP address
        const request = new XMLHttpRequest();
        request.open('GET', `http://localhost:9100/api/ip/${ip}`, true);

        // Display the request result in the map
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                // Success!
                const geoLocations = JSON.parse(request.responseText);

                // Fill the table of geo locations from the resulting geoLocations
                // Geo locations contain an address, an ipv4Range, a location, a network and a country
                const table = document.getElementById('geo-locations');
                table.innerHTML = '';
                // Insert header row
                table.insertRow().innerHTML = '<th>#</th><th>Address</th><th>IP Range</th><th>Latitude</th><th>Longitude</th><th>Network</th><th>Country</th>';
                for (let i = 0; i < geoLocations.length; i++) {
                    const row = table.insertRow(i+1);
                    let pos = 0;
                    let cell = row.insertCell(pos++);
                    cell.innerHTML = i+1;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = geoLocations[i].address;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = `${geoLocations[i].ipv4Start} - ${geoLocations[i].ipv4End}`;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = geoLocations[i].latitude;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = geoLocations[i].longitude;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = geoLocations[i].network;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = geoLocations[i].country;
                }
            } else {
                // We reached our target server, but it returned an error
                console.log('Error');
            }
        };

        request.send();
    }

    /**
     * Convert a string to a unicode byte array
     * @param {string} str
     * @return {Array} of bytes
     */
    function strToUtf8Bytes(str) {
        const utf8 = [];
        for (let ii = 0; ii < str.length; ii++) {
            let charCode = str.charCodeAt(ii);
            if (charCode < 0x80) utf8.push(charCode);
            else if (charCode < 0x800) {
                utf8.push(0xc0 | (charCode >> 6), 0x80 | (charCode & 0x3f));
            } else if (charCode < 0xd800 || charCode >= 0xe000) {
                utf8.push(0xe0 | (charCode >> 12), 0x80 | ((charCode >> 6) & 0x3f), 0x80 | (charCode & 0x3f));
            } else {
                ii++;
                // Surrogate pair:
                // UTF-16 encodes 0x10000-0x10FFFF by subtracting 0x10000 and
                // splitting the 20 bits of 0x0-0xFFFFF into two halves
                charCode = 0x10000 + (((charCode & 0x3ff) << 10) | (str.charCodeAt(ii) & 0x3ff));
                utf8.push(
                    0xf0 | (charCode >> 18),
                    0x80 | ((charCode >> 12) & 0x3f),
                    0x80 | ((charCode >> 6) & 0x3f),
                    0x80 | (charCode & 0x3f),
                );
            }
        }
        return utf8;
    }

</script>
<script src="https://api.ipify.org?format=jsonp&callback=getIP"></script>
</body>
</html>