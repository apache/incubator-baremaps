<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Baremaps Geocoder example</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <style>
        form {
            margin-bottom: 1rem;
        }

        td, th {
            padding: 1rem;
            border: 1px solid black;
        }

        table {
            border-collapse: collapse;
        }
    </style>
</head>
<body>
<!-- A form to submit the IP address -->
<form onsubmit="searchByAddress(event)">
    <label for="address">Address:</label>
    <input type="text" id="address" name="address" value=""/>
    <input type="submit" value="Submit"/>
</form>
<!-- The table of retrieved locations -->
<table id="results"></table>
<script>
    function searchByAddress(event) {
        event.preventDefault();

        // Get the IP address from the form
        var address = document.getElementById('address').value;

        // Make a http request on localhost:9100/api/ip/:ip to retrieve the IP address
        const request = new XMLHttpRequest();
        request.open('GET', `http://localhost:3000/api/geocoder?address=${address}`, true);

        // Set request Accept header to application/json
        request.setRequestHeader('Accept', 'application/json');

        // Display the request result in the map
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                // Success!
                const response = JSON.parse(request.responseText);

                // Write the result address in a href
                // Fill the table of geo locations from the resulting geoLocations
                // Geo locations contain an address, an ipv4Range, a location, a network and a country
                const table = document.getElementById('results');
                table.innerHTML = '';
                // Insert header row
                table.insertRow().innerHTML =
                    `<th>#</th>
                    <th>Score</th>
                    <th>Url</th>
                    <th>Name</th>
                    <th>Ascii name</th>
                    <th>Alternate names</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Feature Class</th>
                    <th>feature Code</th>
                    <th>Country Code</th>
                    <th>Country Code 2</th>
                    <th>Admin1Code</th>
                    <th>Admin2Code</th>
                    <th>Admin3Code</th>
                    <th>Admin4Code</th>
                    <th>Population</th>
                    <th>Elevation</th>
                    <th>Dem</th>
                    <th>Timezone</th>
                    <th>Modification Date</th>`;
                for (let i = 0; i < response.results.length; i++) {
                    const result = response.results[i];
                    const row = table.insertRow(i + 1);
                    let pos = 0;
                    let cell = row.insertCell(pos++);
                    cell.innerHTML = i + 1;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.score;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = `<a href="http://www.openstreetmap.org/?mlat=${result.record.latitude}&mlon=${result.record.longitude}&zoom=15" target="_blank">OSM</a>`;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.name;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.asciiname;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.alternatenames;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.latitude;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.longitude;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.featureClass;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.featureCode;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.countryCode;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.cc2;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.admin1Code;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.admin2Code;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.admin3Code;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.admin4Code;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.population;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.elevation;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.dem;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.timezone;
                    cell = row.insertCell(pos++);
                    cell.innerHTML = result.record.modificationDate;
                }
            } else {
                // We reached our target server, but it returned an error
                console.log('Error');
            }
        };

        request.send();
    }
</script>
</body>
</html>